format_version: 10
pipelines:
  hello-world-build:
    group: hello-world
    display_order: 1
    materials:
      repo:
        git: https://github.com/diegogomesaraujo/hello-pipeline-agocd-argocd.git
        branch: master
    stages:
      - build:
          fetch_materials: true
          keep_artifacts: true
          clean_workspace: false
          jobs:
            build:
              resources:
                - maven
              artifacts:
                - build:
                    source: target/
                    destination: build
                - scripts:
                    source: ops/
                    destination: scripts
              tasks:
                - exec:
                    command: /bin/bash
                    arguments:
                      - mvn clean package
  hello-world-deploy:
    group: hello-world
    display_order: 2
    materials:
      build:
        pipeline: hello-world-build
        stage: build
    stages:
      - build-image:
          fetch_materials: true
          keep_artifacts: true
          clean_workspace: false
          approval:
            allow_only_on_success: true
          jobs:
            build:
              resource:
                - docker
              tasks:
                - fetch:
                    # pipeline: hello-world-build
                    # stage: build
                    job: build
                    source: build/
                    destination: ''
                - fetch:
                    job: build
                    source: scripts/
                    destination: ops
                - exec:
                    command: /bin/bash
                    arguments:
                      - ops/build.sh
      - deploy:
          fetch_materials: false
          approval:
            type: manual
            allow_only_on_success: true
          jobs:
            deploy:
              tasks:
                - fetch:
                    job: build
                    source: scripts/
                    destination: ops
                - exec:
                    command: /bin/bash
                    arguments:
                      - ops/deploy.sh